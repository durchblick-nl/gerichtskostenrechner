<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Schadentool - Prozesskostenrechner</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        :root {
            --primary: #3f606f;
            --primary-light: #5a8a9d;
            --accent: #cc5c53;
            --success: #28a745;
            --warning: #ffc107;
            --bg-light: #f8f9fa;
            --border: #dee2e6;
        }

        .cap-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .cap-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .cap-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            color: white;
        }

        .cap-header p {
            margin: 0;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg-light);
        }

        .section-number {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }

        .section-toggle {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #ccc;
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(63, 96, 111, 0.15);
        }

        .form-group .help-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid var(--primary-light);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .info-box.warning {
            background: #fff3cd;
            border-color: var(--warning);
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-value {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .results-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--primary);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .result-card h4 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 1rem;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-row.total {
            font-weight: bold;
            background: var(--bg-light);
            margin: 10px -10px -10px;
            padding: 12px 10px;
            border-radius: 0 0 8px 8px;
        }

        .result-amount {
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .total-box {
            background: var(--primary);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }

        .total-box h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .total-amount {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #b54a42;
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .ausschoepfung-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
        }

        .ausschoepfung-meter {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .ausschoepfung-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--accent) 100%);
            transition: width 0.3s;
        }

        .hidden {
            display: none !important;
        }

        .section-content.collapsed {
            display: none;
        }

        .gebuhrenrahmen {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
            margin-top: 10px;
        }

        .gebuhrenrahmen span {
            background: var(--bg-light);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .gebuhrenrahmen .label {
            font-weight: 500;
            color: #666;
        }

        .btn-small {
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: var(--primary-light);
        }

        .btn-estimate {
            background: var(--bg-light);
            color: var(--primary);
            border: 1px solid var(--border);
        }

        .btn-estimate:hover {
            background: var(--primary);
            color: white;
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #999;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: normal;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Gebührenrahmen */
        .fee-range {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }

        /* Warning Box */
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
            font-size: 0.9rem;
            display: none;
        }

        .warning-box.visible {
            display: block;
        }

        .info-box-art114 {
            background: #d4edda;
            border-color: var(--success);
        }

        .info-box-art114-arbeitsrecht {
            background: #fff3cd;
            border-color: var(--warning);
        }

        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e8ed 100%);
            border: 1px solid var(--primary-light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Scenario Comparison */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .scenario-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .scenario-card.best {
            border-top: 3px solid var(--success);
        }

        .scenario-card.likely {
            border-top: 3px solid var(--warning);
        }

        .scenario-card.worst {
            border-top: 3px solid var(--accent);
        }

        .scenario-card h5 {
            margin: 0 0 10px 0;
            font-size: 0.85rem;
            color: #666;
        }

        .scenario-amount {
            font-size: 1.3rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* Cost Visualization */
        .cost-bars {
            margin-top: 20px;
        }

        .cost-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .cost-bar-label {
            width: 120px;
            font-size: 0.85rem;
            color: #666;
        }

        .cost-bar-container {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .cost-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .cost-bar-fill.gerichtskosten {
            background: var(--primary);
        }

        .cost-bar-fill.anwaltskosten {
            background: var(--primary-light);
        }

        .cost-bar-fill.pke {
            background: var(--accent);
        }

        .cost-bar-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Timeline */
        .timeline {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 30px 0;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 50%, var(--accent) 100%);
            z-index: 0;
        }

        .timeline-point {
            text-align: center;
            z-index: 1;
            flex: 1;
        }

        .timeline-dot {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .timeline-dot.inactive {
            background: #ccc;
        }

        .timeline-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .timeline-amount {
            font-weight: bold;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .timeline-cumulative {
            font-size: 0.75rem;
            color: #888;
            margin-top: 3px;
        }

        @media print {
            .no-print { display: none !important; }
            .section { break-inside: avoid; page-break-inside: avoid; }
            body { font-size: 10pt; }
            .cap-container { max-width: 100%; padding: 0; }
            .cap-header { background: var(--primary) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .results-section { border: 1px solid #333; }
            .result-card { box-shadow: none; border: 1px solid #ddd; }
            .total-box { background: var(--primary) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .scenario-card { border: 1px solid #ddd; }
            .timeline-dot { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .cost-bar-fill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .summary-box { background: #f5f5f5 !important; border: 1px solid #ccc; }
            h1, h2, h3 { page-break-after: avoid; }
            @page { margin: 1.5cm; }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="cap-container">
        <header class="cap-header no-print">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h1>Schadentool - Prozesskostenrechner</h1>
                    <p>Berechnung voraussichtlicher Kosten für Zivilverfahren</p>
                </div>
                <a href="../fr/cap-tool.html" class="lang-switch" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 20px; text-decoration: none; font-size: 0.9rem; font-weight: 500;">FR</a>
            </div>
        </header>

        <!-- BASISDATEN -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">1</span>
                <h2 class="section-title">Basisdaten</h2>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="fallnummer">Fall-Nummer</label>
                    <input type="text" id="fallnummer" placeholder="z.B. 2025-12345">
                </div>
                <div class="form-group">
                    <label for="datum">Datum</label>
                    <input type="date" id="datum">
                </div>
                <div class="form-group">
                    <label for="kanton">Gerichtsstand (Kanton)</label>
                    <select id="kanton">
                        <option value="AG">Aargau</option>
                        <option value="BE">Bern</option>
                        <option value="BS">Basel-Stadt</option>
                        <option value="GE">Genève</option>
                        <option value="LU">Luzern</option>
                        <option value="SG">St. Gallen</option>
                        <option value="TI">Ticino</option>
                        <option value="VD">Vaud</option>
                        <option value="VS">Valais / Wallis</option>
                        <option value="ZH" selected>Zürich</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="verfahrensart">Verfahrensart</label>
                    <select id="verfahrensart">
                        <option value="ordentlich">Ordentliches / Vereinfachtes Verfahren</option>
                        <option value="summarisch">Summarisches Verfahren</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="rechtsgebiet"><span data-tooltip="Art. 114 ZPO: Bei bestimmten Rechtsgebieten fallen im Schlichtungsverfahren keine Gerichtskosten an">Rechtsgebiet</span></label>
                    <select id="rechtsgebiet">
                        <option value="standard">Standard (kostenpflichtig)</option>
                        <option value="arbeitsrecht">Arbeitsrecht (kostenfrei bis CHF 30'000)</option>
                        <option value="mietrecht">Mietrecht Wohn-/Geschäftsräume (kostenfrei)</option>
                        <option value="gleichstellung">Gleichstellungsgesetz (kostenfrei)</option>
                        <option value="behinderten">Behindertengleichstellungsgesetz (kostenfrei)</option>
                        <option value="mitwirkung">Mitwirkungsgesetz (kostenfrei)</option>
                        <option value="zusatzversicherung">Zusatzversicherung Krankenversicherung (kostenfrei)</option>
                        <option value="datenschutz">Datenschutzgesetz (kostenfrei)</option>
                    </select>
                </div>
            </div>

            <div class="info-box info-box-art114" id="art114-info" style="display: none;">
                <strong>Art. 114 ZPO - Kostenfreies Schlichtungsverfahren:</strong> Bei diesem Rechtsgebiet fallen im Schlichtungsverfahren keine Gerichtskosten an. Die Schlichtungskosten werden auf CHF 0 gesetzt.
            </div>

            <div class="info-box info-box-art114-arbeitsrecht" id="art114-arbeitsrecht-warning" style="display: none;">
                <strong>Hinweis Arbeitsrecht:</strong> Bei arbeitsrechtlichen Streitigkeiten ist das Schlichtungsverfahren nur bis zu einem Streitwert von CHF 30'000 kostenfrei. Bei höherem Streitwert fallen normale Schlichtungskosten an.
            </div>

            <div class="info-box">
                <strong>Streitwert:</strong> Der Streitwert bestimmt die Höhe der Gerichts- und Anwaltskosten. Er entspricht dem Wert des Streitgegenstandes (z.B. eingeklagte Forderung). Bei Berufung/Beschwerde kann sich der Streitwert ändern, wenn nur Teile des Urteils angefochten werden.
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="streitwert1"><span data-tooltip="Wert der eingeklagten Forderung oder des Streitgegenstandes">Streitwert 1. Instanz (CHF)</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="streitwert1" value="50000" min="0" step="1000" style="flex: 1;">
                        <button type="button" class="btn-small" onclick="syncStreitwert()" title="Streitwert für alle Instanzen übernehmen">&#x21BB; Sync</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="streitwert2"><span data-tooltip="Kann abweichen, wenn nur Teile des Urteils angefochten werden">Streitwert 2. Instanz (CHF)</span></label>
                    <input type="number" id="streitwert2" value="50000" min="0" step="1000">
                </div>
                <div class="form-group">
                    <label for="streitwert3"><span data-tooltip="Bundesgericht: Streitwert mind. CHF 15'000 für Beschwerde in Zivilsachen">Streitwert 3. Instanz (CHF)</span></label>
                    <input type="number" id="streitwert3" value="50000" min="0" step="1000">
                </div>
            </div>

            <div class="warning-box" id="streitwert-warning">
                <strong>Hinweis Art. 199 ZPO:</strong> Bei Streitwert über CHF 100'000 können die Parteien auf das Schlichtungsverfahren verzichten (Opt-out). Dies kann Zeit und Kosten sparen.
            </div>
        </section>

        <!-- BEMESSUNGSKRITERIEN -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">2</span>
                <h2 class="section-title">Bemessungskriterien</h2>
            </div>

            <div class="info-box">
                <strong>Honorarausschöpfung:</strong> Die Bemessungskriterien bestimmen, wo innerhalb des Gebührenrahmens die Kosten liegen. 0 = Minimum, 8 = Maximum pro Kriterium.
            </div>

            <div class="form-grid">
                <div class="slider-group">
                    <div class="slider-header">
                        <label>Gebotener Zeitaufwand</label>
                        <span class="slider-value" id="zeitaufwand-label">durchschnittlich</span>
                    </div>
                    <input type="range" id="zeitaufwand" min="0" max="8" step="2" value="4">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <label>Bedeutung der Sache</label>
                        <span class="slider-value" id="bedeutung-label">durchschnittlich</span>
                    </div>
                    <input type="range" id="bedeutung" min="0" max="8" step="2" value="4">
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <label>Schwierigkeit des Falls</label>
                        <span class="slider-value" id="schwierigkeit-label">durchschnittlich</span>
                    </div>
                    <input type="range" id="schwierigkeit" min="0" max="8" step="2" value="4">
                </div>
            </div>

            <div class="ausschoepfung-display">
                <strong>Ausschöpfung Gebührenrahmen:</strong>
                <div class="ausschoepfung-meter">
                    <div class="ausschoepfung-fill" id="ausschoepfung-fill" style="width: 50%"></div>
                </div>
                <span id="ausschoepfung-prozent">50%</span>
            </div>

            <div class="form-grid" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="erfolgsaussichten">Erfolgsaussichten</label>
                    <select id="erfolgsaussichten">
                        <option value="optimistisch">Optimistisch (Vergleich)</option>
                        <option value="neutral">Neutral</option>
                        <option value="pessimistisch" selected>Pessimistisch (Totalverlust)</option>
                    </select>
                    <span class="help-text">Beeinflusst die Berechnung der Parteikostenentschädigung</span>
                </div>
            </div>
        </section>

        <!-- AUSSERGERICHTLICH -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">3</span>
                <h2 class="section-title">Aussergerichtliche Streiterledigung</h2>
                <div class="section-toggle">
                    <span>Aktiv</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="aussergerichtlich-aktiv" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="aussergerichtlich-content" class="section-content">
                <div class="info-box">
                    <strong>Aussergerichtliche Phase:</strong> Hierzu gehören Korrespondenz, Verhandlungen, Mahnungen und Vergleichsgespräche vor Einreichung einer Klage. Diese Phase kann oft einen Rechtsstreit vermeiden.
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="stunden-anwalt">Anzahl Stunden Anwalt</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="stunden-anwalt" value="0" min="0" style="flex: 1;">
                            <button type="button" class="btn-small btn-estimate" onclick="estimateHours()" title="Schätzung basierend auf Streitwert">Schätzung</button>
                        </div>
                        <span class="help-text" id="stunden-help">Klicken Sie auf "Schätzung" für einen Richtwert</span>
                    </div>
                    <div class="form-group">
                        <label for="stundenansatz">Stundenansatz (CHF)</label>
                        <input type="number" id="stundenansatz" value="250" min="0">
                        <span class="help-text">Üblich: CHF 200-400/h je nach Erfahrung</span>
                    </div>
                    <div class="form-group">
                        <label for="expertisen">Expertisen (CHF)</label>
                        <input type="number" id="expertisen" value="0" min="0">
                        <span class="help-text">Gutachten, Bewertungen, Privatgutachten</span>
                    </div>
                    <div class="form-group">
                        <label for="betreibung">Betreibungs-/Rechtsöffnungskosten (CHF)</label>
                        <input type="number" id="betreibung" value="0" min="0">
                        <span class="help-text">Falls bereits Betreibung eingeleitet</span>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="schlichtung-aktiv" checked>
                        <span>Schlichtungsverfahren einbeziehen</span>
                    </label>
                    <span class="help-text" style="margin-left: 30px;">Obligatorisch vor Zivilklage (ausser bei Streitwert > CHF 100'000 mit Opt-out)</span>
                </div>
            </div>
        </section>

        <!-- 1. INSTANZ -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">4</span>
                <h2 class="section-title">1. Instanz - Gerichtliches Verfahren</h2>
                <div class="section-toggle">
                    <span>Aktiv</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="instanz1-aktiv" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="instanz1-content" class="section-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="honorar-vereinbarung">Zusätzliches Honorar nach Vereinbarung (CHF)</label>
                        <input type="number" id="honorar-vereinbarung" value="0" min="0">
                        <span class="help-text">Falls neben PKV-Honorar zusätzliche Vereinbarung besteht</span>
                    </div>
                </div>

                <div class="info-box">
                    <strong>PKV-Honorar:</strong> Das Anwaltshonorar wird nach der kantonalen Parteikostenverordnung (PKV) berechnet und liegt je nach Ausschöpfung zwischen Minimum und Maximum des Gebührenrahmens.
                </div>
            </div>
        </section>

        <!-- 2. INSTANZ -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">5</span>
                <h2 class="section-title">2. Instanz - Berufung / Beschwerde</h2>
                <div class="section-toggle">
                    <span>Aktiv</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="instanz2-aktiv">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div id="instanz2-content" class="section-content collapsed">
                <div class="info-box">
                    Die Kosten für das Berufungsverfahren werden automatisch basierend auf dem Streitwert 2. Instanz und den Bemessungskriterien berechnet.
                </div>
            </div>
        </section>

        <!-- 3. INSTANZ -->
        <section class="section">
            <div class="section-header">
                <span class="section-number">6</span>
                <h2 class="section-title">3. Instanz - Bundesgericht</h2>
                <div class="section-toggle">
                    <span>Aktiv</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="instanz3-aktiv">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div id="instanz3-content" class="section-content collapsed">
                <div class="info-box">
                    Die Bundesgerichtsgebühren richten sich nach dem Bundesgerichtsgesetz (BGG) und dem Reglement über die Gerichtskosten.
                </div>
            </div>
        </section>

        <!-- ERGEBNISSE -->
        <section class="section results-section" id="results-section">
            <div class="section-header">
                <span class="section-number">&#10003;</span>
                <h2 class="section-title">Kostenübersicht</h2>
            </div>

            <div class="results-grid">
                <!-- Aussergerichtlich -->
                <div class="result-card" id="result-aussergerichtlich">
                    <h4>Aussergerichtlich</h4>
                    <div class="result-row">
                        <span>Anwaltshonorar</span>
                        <span class="result-amount" id="r-ag-honorar">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Spesen (3%)</span>
                        <span class="result-amount" id="r-ag-spesen">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>MwSt (7.7%)</span>
                        <span class="result-amount" id="r-ag-mwst">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Schlichtung</span>
                        <span class="result-amount" id="r-ag-schlichtung">CHF 0.00</span>
                    </div>
                    <div class="result-row total">
                        <span>Total</span>
                        <span class="result-amount" id="r-ag-total">CHF 0.00</span>
                    </div>
                </div>

                <!-- 1. Instanz -->
                <div class="result-card" id="result-instanz1">
                    <h4>1. Instanz</h4>
                    <div class="result-row">
                        <span>Gerichtskosten</span>
                        <span class="result-amount" id="r-i1-gericht">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Anwaltshonorar (PKV)</span>
                        <span class="result-amount" id="r-i1-honorar">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Spesen + MwSt</span>
                        <span class="result-amount" id="r-i1-nebenkosten">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>PKE (bei Verlust)</span>
                        <span class="result-amount" id="r-i1-pke">CHF 0.00</span>
                    </div>
                    <div class="result-row total">
                        <span>Total</span>
                        <span class="result-amount" id="r-i1-total">CHF 0.00</span>
                    </div>
                </div>

                <!-- 2. Instanz -->
                <div class="result-card hidden" id="result-instanz2">
                    <h4>2. Instanz</h4>
                    <div class="result-row">
                        <span>Gerichtskosten</span>
                        <span class="result-amount" id="r-i2-gericht">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Anwaltshonorar</span>
                        <span class="result-amount" id="r-i2-honorar">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Spesen + MwSt</span>
                        <span class="result-amount" id="r-i2-nebenkosten">CHF 0.00</span>
                    </div>
                    <div class="result-row total">
                        <span>Total</span>
                        <span class="result-amount" id="r-i2-total">CHF 0.00</span>
                    </div>
                </div>

                <!-- 3. Instanz -->
                <div class="result-card hidden" id="result-instanz3">
                    <h4>3. Instanz (BGer)</h4>
                    <div class="result-row">
                        <span>Gerichtskosten</span>
                        <span class="result-amount" id="r-i3-gericht">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Anwaltshonorar</span>
                        <span class="result-amount" id="r-i3-honorar">CHF 0.00</span>
                    </div>
                    <div class="result-row">
                        <span>Spesen + MwSt</span>
                        <span class="result-amount" id="r-i3-nebenkosten">CHF 0.00</span>
                    </div>
                    <div class="result-row total">
                        <span>Total</span>
                        <span class="result-amount" id="r-i3-total">CHF 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Timeline Visualisierung -->
            <div class="timeline" id="cost-timeline">
                <div class="timeline-point">
                    <div class="timeline-dot" id="tl-dot-ag">AG</div>
                    <div class="timeline-label">Aussergerichtlich</div>
                    <div class="timeline-amount" id="tl-ag">CHF 0</div>
                    <div class="timeline-cumulative" id="tl-ag-cum">Kumuliert: CHF 0</div>
                </div>
                <div class="timeline-point">
                    <div class="timeline-dot" id="tl-dot-i1">1</div>
                    <div class="timeline-label">1. Instanz</div>
                    <div class="timeline-amount" id="tl-i1">CHF 0</div>
                    <div class="timeline-cumulative" id="tl-i1-cum">Kumuliert: CHF 0</div>
                </div>
                <div class="timeline-point">
                    <div class="timeline-dot inactive" id="tl-dot-i2">2</div>
                    <div class="timeline-label">2. Instanz</div>
                    <div class="timeline-amount" id="tl-i2">-</div>
                    <div class="timeline-cumulative" id="tl-i2-cum"></div>
                </div>
                <div class="timeline-point">
                    <div class="timeline-dot inactive" id="tl-dot-i3">3</div>
                    <div class="timeline-label">Bundesgericht</div>
                    <div class="timeline-amount" id="tl-i3">-</div>
                    <div class="timeline-cumulative" id="tl-i3-cum"></div>
                </div>
            </div>

            <!-- Szenario-Vergleich -->
            <h4 style="margin: 25px 0 10px; color: var(--primary);">Szenario-Vergleich</h4>
            <div class="scenario-grid">
                <div class="scenario-card best">
                    <h5>Best Case (Gewinn)</h5>
                    <div class="scenario-amount" id="scenario-best">CHF 0</div>
                    <div class="fee-range">Nur eigene Kosten</div>
                </div>
                <div class="scenario-card likely">
                    <h5>Wahrscheinlich (Vergleich)</h5>
                    <div class="scenario-amount" id="scenario-likely">CHF 0</div>
                    <div class="fee-range">50% Kosten geteilt</div>
                </div>
                <div class="scenario-card worst">
                    <h5>Worst Case (Verlust)</h5>
                    <div class="scenario-amount" id="scenario-worst">CHF 0</div>
                    <div class="fee-range">Inkl. Gegenpartei</div>
                </div>
            </div>

            <!-- Kostenaufschlüsselung Balken -->
            <h4 style="margin: 25px 0 10px; color: var(--primary);">Kostenaufschlüsselung</h4>
            <div class="cost-bars">
                <div class="cost-bar-row">
                    <span class="cost-bar-label">Gerichtskosten</span>
                    <div class="cost-bar-container">
                        <div class="cost-bar-fill gerichtskosten" id="bar-gericht" style="width: 0%"></div>
                        <span class="cost-bar-value" id="bar-gericht-val">CHF 0</span>
                    </div>
                </div>
                <div class="cost-bar-row">
                    <span class="cost-bar-label">Anwaltskosten</span>
                    <div class="cost-bar-container">
                        <div class="cost-bar-fill anwaltskosten" id="bar-anwalt" style="width: 0%"></div>
                        <span class="cost-bar-value" id="bar-anwalt-val">CHF 0</span>
                    </div>
                </div>
                <div class="cost-bar-row">
                    <span class="cost-bar-label">PKE (Verlust)</span>
                    <div class="cost-bar-container">
                        <div class="cost-bar-fill pke" id="bar-pke" style="width: 0%"></div>
                        <span class="cost-bar-value" id="bar-pke-val">CHF 0</span>
                    </div>
                </div>
            </div>

            <div class="total-box">
                <h3>Gesamtaufwand (voraussichtlich)</h3>
                <div class="total-amount" id="r-gesamt">CHF 0.00</div>
            </div>

            <!-- Zusammenfassung -->
            <div class="summary-box" id="summary-box">
                <strong>Zusammenfassung:</strong> <span id="summary-text">Ihre Berechnung wird hier zusammengefasst.</span>
            </div>

            <div class="action-buttons no-print">
                <button class="btn btn-accent" onclick="exportPDF()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Als PDF speichern
                </button>
                <button class="btn btn-outline" onclick="window.print()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                        <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                    </svg>
                    Drucken
                </button>
                <button class="btn btn-outline" onclick="resetForm()">Zurücksetzen</button>
            </div>
        </section>

        <footer style="text-align: center; padding: 30px; color: #666; font-size: 0.85rem;" class="no-print">
            <p>Dieses Tool dient nur zur Orientierung. Die tatsächlichen Kosten können abweichen.</p>
            <p>Datenstand: 2024 | Basierend auf kantonalen Gebührenverordnungen und PKV-Tarifen</p>
        </footer>
    </div>

    <!-- jsPDF für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../scripts/cap-data.js"></script>
    <script src="../scripts/cap-calculator.js"></script>
    <script src="../scripts/cap-pdf.js"></script>
    <script>
        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            // Zuerst gespeicherte Daten laden
            loadFromStorage();

            // Datum auf heute setzen falls leer
            if (!document.getElementById('datum').value) {
                document.getElementById('datum').valueAsDate = new Date();
            }

            // Event Listeners
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', berechneUndZeige);
                input.addEventListener('input', berechneUndZeige);
            });

            // Toggle Listeners
            setupToggle('aussergerichtlich-aktiv', 'aussergerichtlich-content');
            setupToggle('instanz1-aktiv', 'instanz1-content');
            setupToggle('instanz2-aktiv', 'instanz2-content');
            setupToggle('instanz3-aktiv', 'instanz3-content');

            // Slider Labels
            setupSlider('zeitaufwand', 'zeitaufwand-label');
            setupSlider('bedeutung', 'bedeutung-label');
            setupSlider('schwierigkeit', 'schwierigkeit-label');

            // Initial Berechnung
            berechneUndZeige();
        });

        function setupToggle(checkboxId, contentId) {
            const checkbox = document.getElementById(checkboxId);
            const content = document.getElementById(contentId);
            const resultCard = document.getElementById('result-' + checkboxId.replace('-aktiv', ''));

            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    content.classList.remove('collapsed');
                    if (resultCard) resultCard.classList.remove('hidden');
                } else {
                    content.classList.add('collapsed');
                    if (resultCard) resultCard.classList.add('hidden');
                }
                berechneUndZeige();
            });
        }

        function setupSlider(sliderId, labelId) {
            const slider = document.getElementById(sliderId);
            const label = document.getElementById(labelId);
            const labels = ['minimal', 'unterdurchschnittlich', 'durchschnittlich', 'überdurchschnittlich', 'sehr hoch'];

            slider.addEventListener('input', function() {
                const idx = Math.floor(this.value / 2);
                label.textContent = labels[idx] || 'durchschnittlich';
                updateAusschoepfung();
            });
        }

        function updateAusschoepfung() {
            const z = parseInt(document.getElementById('zeitaufwand').value) || 0;
            const b = parseInt(document.getElementById('bedeutung').value) || 0;
            const s = parseInt(document.getElementById('schwierigkeit').value) || 0;
            const prozent = Math.round(((z + b + s) / 24) * 100);

            document.getElementById('ausschoepfung-fill').style.width = prozent + '%';
            document.getElementById('ausschoepfung-prozent').textContent = prozent + '%';
        }

        function berechneUndZeige() {
            updateAusschoepfung();
            updateArt114Info();

            const rechtsgebiet = document.getElementById('rechtsgebiet').value;
            const streitwert1 = parseFloat(document.getElementById('streitwert1').value) || 0;

            // Art. 114 ZPO: Kostenfreies Schlichtungsverfahren prüfen
            const schlichtungKostenfrei = isSchlichtungKostenfrei(rechtsgebiet, streitwert1);

            const params = {
                kanton: document.getElementById('kanton').value,
                streitwert1: streitwert1,
                streitwert2: parseFloat(document.getElementById('streitwert2').value) || 0,
                streitwert3: parseFloat(document.getElementById('streitwert3').value) || 0,
                verfahrensart: document.getElementById('verfahrensart').value,
                rechtsgebiet: rechtsgebiet,
                schlichtungKostenfrei: schlichtungKostenfrei,
                zeitaufwand: parseInt(document.getElementById('zeitaufwand').value) || 0,
                bedeutung: parseInt(document.getElementById('bedeutung').value) || 0,
                schwierigkeit: parseInt(document.getElementById('schwierigkeit').value) || 0,
                erfolgsaussichten: document.getElementById('erfolgsaussichten').value,
                stundenAnwalt: parseFloat(document.getElementById('stunden-anwalt').value) || 0,
                stundenansatz: parseFloat(document.getElementById('stundenansatz').value) || 250,
                expertisen: parseFloat(document.getElementById('expertisen').value) || 0,
                schlichtung: document.getElementById('schlichtung-aktiv').checked,
                betreibung: parseFloat(document.getElementById('betreibung').value) || 0,
                weitereKosten: 0,
                instanz1Aktiv: document.getElementById('instanz1-aktiv').checked,
                instanz2Aktiv: document.getElementById('instanz2-aktiv').checked,
                instanz3Aktiv: document.getElementById('instanz3-aktiv').checked,
                honorarVereinbarung: parseFloat(document.getElementById('honorar-vereinbarung').value) || 0
            };

            const result = CAPCalculator.berechneAlles(params);
            zeigeErgebnisse(result);
        }

        // Art. 114 ZPO: Prüft ob Schlichtung kostenfrei ist
        function isSchlichtungKostenfrei(rechtsgebiet, streitwert) {
            if (rechtsgebiet === 'standard') return false;
            if (rechtsgebiet === 'arbeitsrecht') return streitwert <= 30000;
            // Alle anderen Rechtsgebiete sind immer kostenfrei
            return true;
        }

        // Art. 114 Info-Boxen aktualisieren
        function updateArt114Info() {
            const rechtsgebiet = document.getElementById('rechtsgebiet').value;
            const streitwert = parseFloat(document.getElementById('streitwert1').value) || 0;
            const art114Info = document.getElementById('art114-info');
            const art114ArbeitsrechtWarning = document.getElementById('art114-arbeitsrecht-warning');

            // Alle Info-Boxen verstecken
            art114Info.style.display = 'none';
            art114ArbeitsrechtWarning.style.display = 'none';

            if (rechtsgebiet === 'standard') return;

            if (rechtsgebiet === 'arbeitsrecht') {
                if (streitwert <= 30000) {
                    art114Info.style.display = 'block';
                } else {
                    art114ArbeitsrechtWarning.style.display = 'block';
                }
            } else {
                // Alle anderen kostenfreien Rechtsgebiete
                art114Info.style.display = 'block';
            }
        }

        function zeigeErgebnisse(r) {
            const fmt = CAPCalculator.formatCHF;
            const fmtShort = (v) => 'CHF ' + Math.round(v).toLocaleString('de-CH');

            // Aussergerichtlich
            document.getElementById('r-ag-honorar').textContent = fmt(r.aussergerichtlich.honorarAnwalt);
            document.getElementById('r-ag-spesen').textContent = fmt(r.aussergerichtlich.spesen);
            document.getElementById('r-ag-mwst').textContent = fmt(r.aussergerichtlich.mwst);
            document.getElementById('r-ag-schlichtung').textContent = fmt(r.aussergerichtlich.schlichtung);
            document.getElementById('r-ag-total').textContent = fmt(r.aussergerichtlich.total);

            // 1. Instanz
            document.getElementById('r-i1-gericht').textContent = fmt(r.instanz1.gerichtskosten.berechnet);
            document.getElementById('r-i1-honorar').textContent = fmt(r.instanz1.anwaltshonorar.berechnet + r.instanz1.honorarVereinbarung);
            document.getElementById('r-i1-nebenkosten').textContent = fmt(r.instanz1.spesen + r.instanz1.mwst);
            document.getElementById('r-i1-pke').textContent = fmt(r.instanz1.pke);
            document.getElementById('r-i1-total').textContent = fmt(r.instanz1.total);

            // 2. Instanz
            document.getElementById('r-i2-gericht').textContent = fmt(r.instanz2.gerichtskosten.berechnet);
            document.getElementById('r-i2-honorar').textContent = fmt(r.instanz2.anwaltshonorar.berechnet);
            document.getElementById('r-i2-nebenkosten').textContent = fmt(r.instanz2.spesen + r.instanz2.mwst);
            document.getElementById('r-i2-total').textContent = fmt(r.instanz2.total);

            // 3. Instanz
            document.getElementById('r-i3-gericht').textContent = fmt(r.instanz3.gerichtskosten.berechnet);
            document.getElementById('r-i3-honorar').textContent = fmt(r.instanz3.anwaltshonorar.berechnet);
            document.getElementById('r-i3-nebenkosten').textContent = fmt(r.instanz3.spesen + r.instanz3.mwst);
            document.getElementById('r-i3-total').textContent = fmt(r.instanz3.total);

            // Gesamt
            document.getElementById('r-gesamt').textContent = fmt(r.gesamtTotal);

            // Result cards visibility
            document.getElementById('result-instanz2').classList.toggle('hidden', !r.instanz2.aktiv);
            document.getElementById('result-instanz3').classList.toggle('hidden', !r.instanz3.aktiv);

            // === NEUE VISUALISIERUNGEN ===

            // Streitwert-Warnung
            const streitwert = parseFloat(document.getElementById('streitwert1').value) || 0;
            document.getElementById('streitwert-warning').classList.toggle('visible', streitwert > 100000);

            // Timeline
            document.getElementById('tl-ag').textContent = fmtShort(r.aussergerichtlich.total);
            document.getElementById('tl-ag-cum').textContent = 'Kumuliert: ' + fmtShort(r.gesamtAussergerichtlich);
            document.getElementById('tl-i1').textContent = fmtShort(r.instanz1.total);
            document.getElementById('tl-i1-cum').textContent = 'Kumuliert: ' + fmtShort(r.gesamtInstanz1);

            if (r.instanz2.aktiv) {
                document.getElementById('tl-dot-i2').classList.remove('inactive');
                document.getElementById('tl-i2').textContent = fmtShort(r.instanz2.total);
                document.getElementById('tl-i2-cum').textContent = 'Kumuliert: ' + fmtShort(r.gesamtInstanz2);
            } else {
                document.getElementById('tl-dot-i2').classList.add('inactive');
                document.getElementById('tl-i2').textContent = '-';
                document.getElementById('tl-i2-cum').textContent = '';
            }

            if (r.instanz3.aktiv) {
                document.getElementById('tl-dot-i3').classList.remove('inactive');
                document.getElementById('tl-i3').textContent = fmtShort(r.instanz3.total);
                document.getElementById('tl-i3-cum').textContent = 'Kumuliert: ' + fmtShort(r.gesamtInstanz3);
            } else {
                document.getElementById('tl-dot-i3').classList.add('inactive');
                document.getElementById('tl-i3').textContent = '-';
                document.getElementById('tl-i3-cum').textContent = '';
            }

            // Szenarien berechnen
            const totalPKE = r.instanz1.pke + r.instanz2.pke + r.instanz3.pke;
            const totalGericht = r.instanz1.gerichtskosten.berechnet + r.instanz2.gerichtskosten.berechnet + r.instanz3.gerichtskosten.berechnet;
            const totalAnwalt = r.aussergerichtlich.honorarAnwalt + r.aussergerichtlich.spesen + r.aussergerichtlich.mwst +
                              r.instanz1.anwaltshonorar.berechnet + r.instanz1.spesen + r.instanz1.mwst +
                              r.instanz2.anwaltshonorar.berechnet + r.instanz2.spesen + r.instanz2.mwst +
                              r.instanz3.anwaltshonorar.berechnet + r.instanz3.spesen + r.instanz3.mwst;

            const bestCase = totalAnwalt + r.aussergerichtlich.schlichtung + r.aussergerichtlich.expertisen;
            const worstCase = r.gesamtTotal;
            const likelyCase = Math.round((bestCase + worstCase) / 2);

            document.getElementById('scenario-best').textContent = fmtShort(bestCase);
            document.getElementById('scenario-likely').textContent = fmtShort(likelyCase);
            document.getElementById('scenario-worst').textContent = fmtShort(worstCase);

            // Kostenbalken
            const maxCost = Math.max(totalGericht, totalAnwalt, totalPKE, 1);
            document.getElementById('bar-gericht').style.width = (totalGericht / maxCost * 80) + '%';
            document.getElementById('bar-gericht-val').textContent = fmtShort(totalGericht);
            document.getElementById('bar-anwalt').style.width = (totalAnwalt / maxCost * 80) + '%';
            document.getElementById('bar-anwalt-val').textContent = fmtShort(totalAnwalt);
            document.getElementById('bar-pke').style.width = (totalPKE / maxCost * 80) + '%';
            document.getElementById('bar-pke-val').textContent = fmtShort(totalPKE);

            // Zusammenfassung generieren
            const kantonName = r.kantonName.de;
            const verfahren = document.getElementById('verfahrensart').value === 'summarisch' ? 'summarisches' : 'ordentliches';
            let instanzen = '1. Instanz';
            if (r.instanz2.aktiv && r.instanz3.aktiv) instanzen = 'alle drei Instanzen';
            else if (r.instanz2.aktiv) instanzen = '1. und 2. Instanz';

            const summary = `Für ein ${verfahren} Verfahren im Kanton ${kantonName} mit einem Streitwert von ${fmtShort(streitwert)} ` +
                          `betragen die voraussichtlichen Kosten für ${instanzen} insgesamt <strong>${fmt(r.gesamtTotal)}</strong>. ` +
                          `Bei einem Vergleich (50/50) wären es ca. ${fmtShort(likelyCase)}, bei vollständigem Obsiegen nur ${fmtShort(bestCase)}.`;
            document.getElementById('summary-text').innerHTML = summary;

            // In LocalStorage speichern
            saveToStorage();
        }

        function exportPDF() {
            // Aktuelle Berechnung durchführen
            const rechtsgebiet = document.getElementById('rechtsgebiet').value;
            const streitwert1 = parseFloat(document.getElementById('streitwert1').value) || 0;
            const schlichtungKostenfrei = isSchlichtungKostenfrei(rechtsgebiet, streitwert1);

            const params = {
                kanton: document.getElementById('kanton').value,
                streitwert1: streitwert1,
                streitwert2: parseFloat(document.getElementById('streitwert2').value) || 0,
                streitwert3: parseFloat(document.getElementById('streitwert3').value) || 0,
                verfahrensart: document.getElementById('verfahrensart').value,
                rechtsgebiet: rechtsgebiet,
                schlichtungKostenfrei: schlichtungKostenfrei,
                zeitaufwand: parseInt(document.getElementById('zeitaufwand').value) || 0,
                bedeutung: parseInt(document.getElementById('bedeutung').value) || 0,
                schwierigkeit: parseInt(document.getElementById('schwierigkeit').value) || 0,
                erfolgsaussichten: document.getElementById('erfolgsaussichten').value,
                stundenAnwalt: parseFloat(document.getElementById('stunden-anwalt').value) || 0,
                stundenansatz: parseFloat(document.getElementById('stundenansatz').value) || 250,
                expertisen: parseFloat(document.getElementById('expertisen').value) || 0,
                schlichtung: document.getElementById('schlichtung-aktiv').checked,
                betreibung: parseFloat(document.getElementById('betreibung').value) || 0,
                weitereKosten: 0,
                instanz1Aktiv: document.getElementById('instanz1-aktiv').checked,
                instanz2Aktiv: document.getElementById('instanz2-aktiv').checked,
                instanz3Aktiv: document.getElementById('instanz3-aktiv').checked,
                honorarVereinbarung: parseFloat(document.getElementById('honorar-vereinbarung').value) || 0,
                fallnummer: document.getElementById('fallnummer').value,
                datum: document.getElementById('datum').valueAsDate || new Date()
            };

            const result = CAPCalculator.berechneAlles(params);
            CAPPdfExport.generatePDF(result, params, 'de');
        }

        function resetForm() {
            document.getElementById('streitwert1').value = 50000;
            document.getElementById('streitwert2').value = 50000;
            document.getElementById('streitwert3').value = 50000;
            document.getElementById('zeitaufwand').value = 4;
            document.getElementById('bedeutung').value = 4;
            document.getElementById('schwierigkeit').value = 4;
            document.getElementById('stunden-anwalt').value = 0;
            document.getElementById('stundenansatz').value = 250;
            document.getElementById('expertisen').value = 0;
            document.getElementById('betreibung').value = 0;
            document.getElementById('honorar-vereinbarung').value = 0;
            document.getElementById('instanz2-aktiv').checked = false;
            document.getElementById('instanz3-aktiv').checked = false;

            // Trigger recalculation
            berechneUndZeige();

            // Update UI
            document.getElementById('instanz2-content').classList.add('collapsed');
            document.getElementById('instanz3-content').classList.add('collapsed');
        }

        function syncStreitwert() {
            const streitwert1 = document.getElementById('streitwert1').value;
            document.getElementById('streitwert2').value = streitwert1;
            document.getElementById('streitwert3').value = streitwert1;
            berechneUndZeige();
        }

        function estimateHours() {
            const streitwert = parseFloat(document.getElementById('streitwert1').value) || 0;
            let hours = 0;
            let description = '';

            // Schätzung basierend auf Streitwert (für aussergerichtliche Phase)
            if (streitwert <= 5000) {
                hours = 3;
                description = '~3h für kleine Fälle';
            } else if (streitwert <= 10000) {
                hours = 5;
                description = '~5h für einfache Fälle';
            } else if (streitwert <= 30000) {
                hours = 10;
                description = '~10h für mittlere Fälle';
            } else if (streitwert <= 50000) {
                hours = 15;
                description = '~15h für grössere Fälle';
            } else if (streitwert <= 100000) {
                hours = 20;
                description = '~20h für umfangreiche Fälle';
            } else if (streitwert <= 250000) {
                hours = 30;
                description = '~30h für komplexe Fälle';
            } else if (streitwert <= 500000) {
                hours = 40;
                description = '~40h für sehr komplexe Fälle';
            } else {
                hours = 60;
                description = '~60h+ für Grossverfahren';
            }

            document.getElementById('stunden-anwalt').value = hours;
            document.getElementById('stunden-help').textContent = description + ' (Richtwert)';
            berechneUndZeige();
        }

        // === LOCAL STORAGE ===
        const STORAGE_KEY = 'cap_tool_data_de';

        function saveToStorage() {
            const data = {
                fallnummer: document.getElementById('fallnummer').value,
                datum: document.getElementById('datum').value,
                kanton: document.getElementById('kanton').value,
                verfahrensart: document.getElementById('verfahrensart').value,
                rechtsgebiet: document.getElementById('rechtsgebiet').value,
                streitwert1: document.getElementById('streitwert1').value,
                streitwert2: document.getElementById('streitwert2').value,
                streitwert3: document.getElementById('streitwert3').value,
                zeitaufwand: document.getElementById('zeitaufwand').value,
                bedeutung: document.getElementById('bedeutung').value,
                schwierigkeit: document.getElementById('schwierigkeit').value,
                erfolgsaussichten: document.getElementById('erfolgsaussichten').value,
                stundenAnwalt: document.getElementById('stunden-anwalt').value,
                stundenansatz: document.getElementById('stundenansatz').value,
                expertisen: document.getElementById('expertisen').value,
                betreibung: document.getElementById('betreibung').value,
                honorarVereinbarung: document.getElementById('honorar-vereinbarung').value,
                schlichtungAktiv: document.getElementById('schlichtung-aktiv').checked,
                aussergerichtlichAktiv: document.getElementById('aussergerichtlich-aktiv').checked,
                instanz1Aktiv: document.getElementById('instanz1-aktiv').checked,
                instanz2Aktiv: document.getElementById('instanz2-aktiv').checked,
                instanz3Aktiv: document.getElementById('instanz3-aktiv').checked,
                savedAt: new Date().toISOString()
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.warn('LocalStorage nicht verfügbar:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;

                const data = JSON.parse(saved);

                // Nur laden wenn nicht älter als 7 Tage
                const savedAt = new Date(data.savedAt);
                const daysDiff = (new Date() - savedAt) / (1000 * 60 * 60 * 24);
                if (daysDiff > 7) {
                    localStorage.removeItem(STORAGE_KEY);
                    return;
                }

                // Werte wiederherstellen
                if (data.fallnummer) document.getElementById('fallnummer').value = data.fallnummer;
                if (data.datum) document.getElementById('datum').value = data.datum;
                if (data.kanton) document.getElementById('kanton').value = data.kanton;
                if (data.verfahrensart) document.getElementById('verfahrensart').value = data.verfahrensart;
                if (data.rechtsgebiet) document.getElementById('rechtsgebiet').value = data.rechtsgebiet;
                if (data.streitwert1) document.getElementById('streitwert1').value = data.streitwert1;
                if (data.streitwert2) document.getElementById('streitwert2').value = data.streitwert2;
                if (data.streitwert3) document.getElementById('streitwert3').value = data.streitwert3;
                if (data.zeitaufwand) document.getElementById('zeitaufwand').value = data.zeitaufwand;
                if (data.bedeutung) document.getElementById('bedeutung').value = data.bedeutung;
                if (data.schwierigkeit) document.getElementById('schwierigkeit').value = data.schwierigkeit;
                if (data.erfolgsaussichten) document.getElementById('erfolgsaussichten').value = data.erfolgsaussichten;
                if (data.stundenAnwalt) document.getElementById('stunden-anwalt').value = data.stundenAnwalt;
                if (data.stundenansatz) document.getElementById('stundenansatz').value = data.stundenansatz;
                if (data.expertisen) document.getElementById('expertisen').value = data.expertisen;
                if (data.betreibung) document.getElementById('betreibung').value = data.betreibung;
                if (data.honorarVereinbarung) document.getElementById('honorar-vereinbarung').value = data.honorarVereinbarung;

                // Checkboxen
                document.getElementById('schlichtung-aktiv').checked = data.schlichtungAktiv !== false;
                document.getElementById('aussergerichtlich-aktiv').checked = data.aussergerichtlichAktiv !== false;
                document.getElementById('instanz1-aktiv').checked = data.instanz1Aktiv !== false;
                document.getElementById('instanz2-aktiv').checked = data.instanz2Aktiv === true;
                document.getElementById('instanz3-aktiv').checked = data.instanz3Aktiv === true;

                // UI aktualisieren
                if (!data.aussergerichtlichAktiv) document.getElementById('aussergerichtlich-content').classList.add('collapsed');
                if (!data.instanz1Aktiv) document.getElementById('instanz1-content').classList.add('collapsed');
                if (data.instanz2Aktiv) document.getElementById('instanz2-content').classList.remove('collapsed');
                if (data.instanz3Aktiv) document.getElementById('instanz3-content').classList.remove('collapsed');

            } catch (e) {
                console.warn('Fehler beim Laden:', e);
            }
        }
    </script>
</body>
</html>
